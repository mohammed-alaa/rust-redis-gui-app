name: Daily Dependency Updates (Yarn + ncu)

on:
    schedule:
        - cron: "0 0 * * *"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

jobs:
    update-deps:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.FRONTEND_PACKAGE_UPDATER }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Install ncu globally
              run: yarn global add npm-check-updates

            - name: Check for outdated packages
              id: check
              run: |
                  echo "Running ncu..."
                  OUTPUT=$(ncu 2>&1 || true)        # ncu exits with code 1 when updates exist â†’ we ignore it
                  echo "$OUTPUT"

                  if echo "$OUTPUT" | grep -q "All dependencies match the latest package versions"; then
                    echo "No updates found"
                    echo "has_updates=false" >> $GITHUB_OUTPUT
                  else
                    echo "Updates found!"
                    echo "has_updates=true" >> $GITHUB_OUTPUT
                    echo "$OUTPUT" > ncu-output.txt
                  fi

            - name: Upgrade package.json + yarn.lock
              if: steps.check.outputs.has_updates == 'true'
              run: |
                  ncu -u
                  yarn install

            - name: Create Pull Request
              if: steps.check.outputs.has_updates == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.FRONTEND_PACKAGE_UPDATER }}
                  branch: chore/dependency-updates
                  delete-branch: true
                  commit-message: "chore(deps): update dependencies"
                  title: "Update dependencies"
                  body: |
                      Daily automated dependency update (Yarn + ncu)

                      ```text
                      $(cat ncu-output.txt)
