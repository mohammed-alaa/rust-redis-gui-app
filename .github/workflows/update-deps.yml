name: Daily Dependency Updates (Yarn + ncu)

on:
    schedule:
        - cron: "0 0 * * *"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write
    checks: write
    actions: write

jobs:
    update-deps:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: yarn

            - name: Install npm-check-updates
              run: yarn global add npm-check-updates

            - name: Check for outdated packages
              id: ncu
              run: |
                  echo "Running ncu check..."
                  ncu_output=$(ncu --format group 2>&1 || true)

                  echo "$ncu_output"

                  # Save full output for the PR body
                  echo "report<<EOF" >> $GITHUB_OUTPUT
                  echo "$ncu_output" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

                  # Set flag if updates exist
                  if echo "$ncu_output" | grep -q "→"; then
                    echo "has_updates=true" >> $GITHUB_OUTPUT
                  else
                    echo "has_updates=false" >> $GITHUB_OUTPUT
                  fi

            - name: Update dependencies
              if: steps.ncu.outputs.has_updates == 'true'
              run: |
                  ncu -u
                  yarn install --mode=update-lockfile

            - name: Create or update Pull Request
              if: steps.ncu.outputs.has_updates == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: chore/dependency-updates
                  delete-branch: true
                  commit-message: "chore(deps): update dependencies"
                  title: "chore(deps): update dependencies"
                  body: |
                      Daily automated dependency update (Yarn + ncu)

                      <details>
                      <summary>Updated packages – click to expand</summary>

                      ```text
                      ${{ steps.ncu.outputs.report }}
